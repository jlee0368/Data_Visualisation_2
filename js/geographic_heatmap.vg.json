{
  "$schema":"https://vega.github.io/schema/vega-lite/v5.json",
  "data": {
    "url": "https://jlee0368.github.io/Data_Visualisation_2/data/MyRTKnet_station_loc_cleaned.csv",
    "format": { "type": "csv", "parse": { "Latitude": "number", "Longitude": "number" } }
  },
  "transform": [
    { "calculate": "datum.State === 'W.P. Kuala Lumpur' ? 'Kuala Lumpur' : datum.State === 'W.P. Putrajaya' ? 'Putrajaya' : datum.State === 'W.P. Labuan' ? 'Labuan' : datum.State", "as": "State_key" },
    {
      "lookup": "State_key",
      "from": {
        "data": { "url": "https://jlee0368.github.io/Data_Visualisation_2/data/malaysian_cities.csv" },
        "key": "admin_name",
        "fields": ["city","lat","lng"],
        "transform": [
          { "filter": "datum.country === 'Malaysia' && isValid(datum.admin_name)" },
          { "calculate": "toNumber(datum.population)", "as": "pop" },
          { "window": [ { "op": "rank", "as": "r" } ], "sort": [ { "field": "pop", "order": "descending" } ], "groupby": ["admin_name"] },
          { "filter": "datum.r === 1" }
        ]
      },
      "as": ["city","city_lat","city_lon"]
    },
    { "calculate": "0.017453292519943295 * datum.Latitude",  "as": "lat1" },
    { "calculate": "0.017453292519943295 * datum.Longitude", "as": "lon1" },
    { "calculate": "0.017453292519943295 * toNumber(datum.city_lat)", "as": "lat2" },
    { "calculate": "0.017453292519943295 * toNumber(datum.city_lon)", "as": "lon2" },
    { "calculate": "2 * 6371 * asin(sqrt(pow(sin((datum.lat2 - datum.lat1)/2),2) + cos(datum.lat1)*cos(datum.lat2)*pow(sin((datum.lon2 - datum.lon1)/2),2)))", "as": "dist_km" },
    { "filter": "isValid(datum.dist_km) && !isNaN(datum.dist_km)" }
  ],
  "mark": "rect",
  "width": 640,
  "height": 440,
  "encoding": {
    "x": { "bin": { "maxbins": 40 }, "field": "Longitude", "type": "quantitative", "title": "Longitude" },
    "y": { "bin": { "maxbins": 40 }, "field": "Latitude",  "type": "quantitative", "title": "Latitude" },
    "color": {
      "aggregate": "mean",
      "field": "dist_km",
      "type": "quantitative",
      "title": "Avg distance (km)",
      "scale": { "scheme": "blues", "reverse": true }
    },
    "tooltip": [
      { "aggregate": "count", "title": "Stations" },
      { "aggregate": "mean", "field": "dist_km", "title": "Average distance (km)", "format": ".1f" }
    ]
  },
  "config": { "view": { "stroke": null } },
  "title": "Mean MyRTKnet Stations to City Distance (Binned)"
}
